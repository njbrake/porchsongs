# Definition of Done

## Test Requirements

**Bug fixes must include a test** that reproduces the bug and verifies the fix. Feature changes should include tests for new behavior. If an existing test file covers the component/module, add tests there; otherwise create a new `*.test.ts(x)` file following existing patterns.

## Checks

Every change must pass all checks before it's considered complete:

```bash
uv run ruff check backend/                    # backend lint
uv run ruff format --check backend/           # backend formatting
cd frontend && npx eslint src/                # frontend lint
cd frontend && npm run typecheck              # TypeScript type check
DATABASE_URL="sqlite:///:memory:" uv run pytest  # backend tests
cd frontend && npx vitest run                 # frontend tests
```

## PR Submissions with UI Changes

PRs that include frontend/UI changes must attach a **Playwright-recorded video** (`.webm`) in the PR description demonstrating the change. This ensures reviewers can visually verify layout, styling, and interactions without pulling the branch locally.

### How to record

Use a short Playwright script to record a `.webm` video of the relevant workflow. This uses `playwright-core` which is already installed as a dependency of the e2e tests.

```bash
# Start the dev server first
cd frontend && npm run dev &
```

```js
node -e "
const { chromium } = require('playwright-core');
(async () => {
  const browser = await chromium.launch({
    headless: true,
    chromiumSandbox: false,
    executablePath: '/root/.cache/ms-playwright/chromium-1208/chrome-linux/chrome'
  });
  const context = await browser.newContext({
    viewport: { width: 1280, height: 900 },
    recordVideo: { dir: 'test-results/', size: { width: 1280, height: 900 } }
  });
  const page = await context.newPage();

  // Navigate and interact with the UI change you're demonstrating
  await page.goto('http://localhost:5173/app');
  await page.waitForTimeout(2000);

  // ... add interactions that demonstrate the change ...

  await context.close();  // video is saved on context close
  await browser.close();
  console.log('Video saved to test-results/');
})();
"
```

### Where videos land

Videos are saved to `test-results/` as `.webm` files. The filename is auto-generated by Playwright.

### Attaching to the PR

**Option A — Manual (inline playback):** Drag the `.webm` file into the PR description editor on GitHub. This is the only way to get inline video playback (GitHub reserves it for `user-attachments/assets/` URLs).

**Option B — Script (download link):** Use the upload script to attach the video as a release asset and post a PR comment with a download link:

```bash
./scripts/upload-pr-video.sh <pr-number> <path-to-video.webm>
```

The script uploads the video to the `ci-assets` pre-release and posts a comment on the PR. The video renders as a download link (not inline player) — reviewers click to download and view.

**For AI agents:** Always use Option B after creating a PR with UI changes. The script handles release asset upload and PR commenting automatically. Example workflow:

```bash
# 1. Record the video (see "How to record" above)
# 2. Find the video file
VIDEO_FILE=$(ls -t test-results/*.webm 2>/dev/null | head -1)
# 3. Upload and comment on the PR
./scripts/upload-pr-video.sh 123 "$VIDEO_FILE"
```
